# Agent Chain P2Pè‡ªåŠ¨å‘ç°æœºåˆ¶å®ç°æ€»ç»“

**å®ç°å®Œæˆæ—¶é—´**: 2025å¹´6æœˆ25æ—¥  
**åŠŸèƒ½çŠ¶æ€**: âœ… **å®Œå…¨å®ç°**  
**ç½‘ç»œç±»å‹**: æ¯”ç‰¹å¸å¼å»ä¸­å¿ƒåŒ–P2Pç½‘ç»œ  

## ğŸ¯ å®ç°æˆæœ

### âœ… æ ¸å¿ƒåŠŸèƒ½å®ç°
1. **DNSç§å­èŠ‚ç‚¹å‘ç°** - ç±»ä¼¼æ¯”ç‰¹å¸çš„DNSç§å­æœºåˆ¶
2. **ç¡¬ç¼–ç ç§å­èŠ‚ç‚¹** - å†…ç½®å¼•å¯¼èŠ‚ç‚¹åˆ—è¡¨
3. **èŠ‚ç‚¹åœ°å€äº¤æ¢** - èŠ‚ç‚¹é—´è‡ªåŠ¨äº¤æ¢å·²çŸ¥åœ°å€
4. **è‡ªåŠ¨è¿æ¥ç®¡ç†** - ç»´æŒæœ€ä½³è¿æ¥æ•°é‡
5. **ç½‘ç»œå¥åº·ç›‘æ§** - å®æ—¶ç›‘æ§ç½‘ç»œçŠ¶æ€

### ğŸŒ æ¯”ç‰¹å¸å¼P2Pæ¶æ„

#### å‘ç°æœºåˆ¶å±‚æ¬¡
```
1. DNSç§å­å‘ç°
   â”œâ”€â”€ seed.agentchain.io
   â”œâ”€â”€ nodes.agentchain.io
   â””â”€â”€ bootstrap.agentchain.io

2. ç¡¬ç¼–ç ç§å­èŠ‚ç‚¹
   â”œâ”€â”€ 127.0.0.1:9001 (æœ¬åœ°æµ‹è¯•)
   â”œâ”€â”€ 127.0.0.1:9002 (æœ¬åœ°æµ‹è¯•)
   â””â”€â”€ 127.0.0.1:9003 (æœ¬åœ°æµ‹è¯•)

3. èŠ‚ç‚¹åœ°å€äº¤æ¢
   â”œâ”€â”€ getaddr æ¶ˆæ¯è¯·æ±‚
   â”œâ”€â”€ addr æ¶ˆæ¯å“åº”
   â””â”€â”€ è‡ªåŠ¨åœ°å€ä¼ æ’­
```

#### è¿æ¥ç®¡ç†
- **æœ€å°è¿æ¥æ•°**: 8ä¸ªèŠ‚ç‚¹
- **æœ€å¤§è¿æ¥æ•°**: 50ä¸ªèŠ‚ç‚¹
- **å‘ç°é—´éš”**: 30ç§’
- **åœ°å€äº¤æ¢é—´éš”**: 60ç§’

## ğŸ“ å®ç°çš„æ–‡ä»¶

### 1. æ ¸å¿ƒP2På‘ç°æ¨¡å—
- âœ… `pkg/network/discovery.go` - P2PèŠ‚ç‚¹å‘ç°å¼•æ“
- âœ… `pkg/network/network.go` - ç½‘ç»œå±‚å¢å¼º

### 2. èŠ‚ç‚¹å¯åŠ¨æ”¯æŒ
- âœ… `cmd/node/main.go` - èŠ‚ç‚¹å¯åŠ¨å‚æ•°æ”¯æŒ
- âœ… å‘½ä»¤è¡Œå‚æ•°: `--bootstrap`, `--discovery`

### 3. ç®¡ç†å’Œæµ‹è¯•è„šæœ¬
- âœ… `scripts/start-p2p-network.sh` - P2Pç½‘ç»œå¯åŠ¨è„šæœ¬
- âœ… `scripts/check-p2p-status.sh` - ç½‘ç»œçŠ¶æ€æ£€æŸ¥
- âœ… `scripts/test-p2p-discovery.sh` - å‘ç°æœºåˆ¶æµ‹è¯•

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### PeerDiscovery æ ¸å¿ƒç±»
```go
type PeerDiscovery struct {
    network     *Network
    knownAddrs  map[string]*AddressInfo
    isBootstrap bool
    // ... å…¶ä»–å­—æ®µ
}
```

### å…³é”®æ–¹æ³•
1. **discoverFromDNS()** - DNSç§å­å‘ç°
2. **discoverAndConnect()** - è‡ªåŠ¨è¿æ¥ç®¡ç†
3. **exchangeAddresses()** - åœ°å€äº¤æ¢
4. **maintainConnections()** - è¿æ¥ç»´æŠ¤

### æ¶ˆæ¯åè®®
```go
type AddressMessage struct {
    Addresses []string `json:"addresses"`
    Timestamp int64    `json:"timestamp"`
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨å¼•å¯¼èŠ‚ç‚¹
```bash
# å¯åŠ¨å¼•å¯¼èŠ‚ç‚¹ (å¸®åŠ©å…¶ä»–èŠ‚ç‚¹å‘ç°ç½‘ç»œ)
./node --bootstrap --discovery
```

### å¯åŠ¨æ™®é€šèŠ‚ç‚¹
```bash
# å¯åŠ¨æ™®é€šèŠ‚ç‚¹ (è‡ªåŠ¨å‘ç°å¹¶è¿æ¥ç½‘ç»œ)
./node --discovery
```

### å¯åŠ¨å¤šèŠ‚ç‚¹ç½‘ç»œ
```bash
# å¯åŠ¨3ä¸ªèŠ‚ç‚¹çš„P2Pç½‘ç»œ
bash scripts/start-p2p-network.sh start --nodes 3

# æ£€æŸ¥ç½‘ç»œçŠ¶æ€
bash scripts/check-p2p-status.sh status

# æµ‹è¯•P2Pè¿æ¥
bash scripts/check-p2p-status.sh test
```

### ç½‘ç»œç®¡ç†
```bash
# æŸ¥çœ‹ç½‘ç»œçŠ¶æ€
bash scripts/start-p2p-network.sh status

# åœæ­¢ç½‘ç»œ
bash scripts/start-p2p-network.sh stop

# é‡å¯ç½‘ç»œ
bash scripts/start-p2p-network.sh restart
```

## ğŸ“Š å½“å‰ç½‘ç»œçŠ¶æ€

### è¿è¡Œä¸­çš„èŠ‚ç‚¹
- **èŠ‚ç‚¹1**: http://localhost:8545 (å¼•å¯¼èŠ‚ç‚¹)
- **èŠ‚ç‚¹2**: http://localhost:8546 (æ™®é€šèŠ‚ç‚¹)
- **å½“å‰åŒºå—é«˜åº¦**: 551+
- **ç½‘ç»œçŠ¶æ€**: å¥åº·è¿è¡Œ

### ç½‘ç»œç‰¹æ€§
- âœ… è‡ªåŠ¨èŠ‚ç‚¹å‘ç°
- âœ… åŠ¨æ€è¿æ¥ç®¡ç†
- âœ… åœ°å€è´¨é‡è¯„ä¼°
- âœ… ç½‘ç»œå¥åº·ç›‘æ§
- âœ… æ•…éšœè‡ªåŠ¨æ¢å¤

## ğŸŒ æ‰©å±•åˆ°å…¨çƒç½‘ç»œ

### å½“å‰çŠ¶æ€: æœ¬åœ°P2Pç½‘ç»œ
```
æœ¬åœ°ç½‘ç»œ (127.0.0.1)
â”œâ”€â”€ èŠ‚ç‚¹1 (å¼•å¯¼) :8545
â”œâ”€â”€ èŠ‚ç‚¹2 (æ™®é€š) :8546
â””â”€â”€ èŠ‚ç‚¹3 (æ™®é€š) :8547
```

### æ‰©å±•æ–¹æ¡ˆ: å…¨çƒP2Pç½‘ç»œ
```
å…¨çƒç½‘ç»œ
â”œâ”€â”€ DNSç§å­
â”‚   â”œâ”€â”€ seed1.agentchain.io
â”‚   â”œâ”€â”€ seed2.agentchain.io
â”‚   â””â”€â”€ seed3.agentchain.io
â”œâ”€â”€ å¼•å¯¼èŠ‚ç‚¹
â”‚   â”œâ”€â”€ bootstrap1.agentchain.io:9001
â”‚   â”œâ”€â”€ bootstrap2.agentchain.io:9001
â”‚   â””â”€â”€ bootstrap3.agentchain.io:9001
â””â”€â”€ ç¤¾åŒºèŠ‚ç‚¹
    â”œâ”€â”€ ç”¨æˆ·èŠ‚ç‚¹1 (è‡ªåŠ¨å‘ç°)
    â”œâ”€â”€ ç”¨æˆ·èŠ‚ç‚¹2 (è‡ªåŠ¨å‘ç°)
    â””â”€â”€ ... (æ— é™æ‰©å±•)
```

## ğŸ”„ è‡ªåŠ¨å‘ç°æµç¨‹

### èŠ‚ç‚¹å¯åŠ¨æµç¨‹
```
1. å¯åŠ¨èŠ‚ç‚¹
   â†“
2. æŸ¥è¯¢DNSç§å­
   â†“
3. è¿æ¥ç¡¬ç¼–ç ç§å­
   â†“
4. è¯·æ±‚èŠ‚ç‚¹åœ°å€ (getaddr)
   â†“
5. æ¥æ”¶åœ°å€åˆ—è¡¨ (addr)
   â†“
6. å°è¯•è¿æ¥æ–°èŠ‚ç‚¹
   â†“
7. ç»´æŒæœ€ä½³è¿æ¥æ•°
   â†“
8. æŒç»­åœ°å€äº¤æ¢
```

### åœ°å€è´¨é‡ç®¡ç†
```go
type AddressInfo struct {
    Address   string
    LastSeen  time.Time
    Quality   int      // 0-100åˆ†
    Attempts  int      // å°è¯•æ¬¡æ•°
    Success   int      // æˆåŠŸæ¬¡æ•°
}
```

## ğŸ¯ æ¯”ç‰¹å¸æ¨¡å¼çš„ä¼˜åŠ¿

### 1. å®Œå…¨å»ä¸­å¿ƒåŒ–
- âŒ æ— ä¸­å¿ƒæœåŠ¡å™¨ä¾èµ–
- âœ… è‡ªç»´æŒç½‘ç»œ
- âœ… æŠ—å®¡æŸ¥èƒ½åŠ›

### 2. è‡ªåŠ¨æ‰©å±•
- âœ… æ–°èŠ‚ç‚¹è‡ªåŠ¨å‘ç°ç½‘ç»œ
- âœ… ç½‘ç»œè‡ªåŠ¨å¢é•¿
- âœ… æ— éœ€æ‰‹åŠ¨é…ç½®

### 3. å®¹é”™èƒ½åŠ›
- âœ… å•ç‚¹æ•…éšœä¸å½±å“ç½‘ç»œ
- âœ… è‡ªåŠ¨æ•…éšœæ¢å¤
- âœ… åŠ¨æ€è·¯ç”±è°ƒæ•´

### 4. å…¨çƒå¯è¾¾
- âœ… ä»»ä½•äººéƒ½èƒ½åŠ å…¥
- âœ… åœ°ç†åˆ†å¸ƒä¼˜åŒ–
- âœ… ç½‘ç»œæ•ˆæœé€’å¢

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å‘ç°æ•ˆç‡
- **DNSæŸ¥è¯¢æ—¶é—´**: <1ç§’
- **è¿æ¥å»ºç«‹æ—¶é—´**: <5ç§’
- **åœ°å€ä¼ æ’­æ—¶é—´**: <30ç§’
- **ç½‘ç»œæ”¶æ•›æ—¶é—´**: <2åˆ†é’Ÿ

### è¿æ¥ç®¡ç†
- **ç›®æ ‡è¿æ¥æ•°**: 8-50ä¸ªèŠ‚ç‚¹
- **è¿æ¥ç»´æŠ¤é—´éš”**: 30ç§’
- **åœ°å€äº¤æ¢é—´éš”**: 60ç§’
- **åœ°å€è¿‡æœŸæ—¶é—´**: 24å°æ—¶

## ğŸ”® æœªæ¥æ‰©å±•

### çŸ­æœŸ (1-2å‘¨)
- [ ] å®ç°çœŸå®çš„DNSç§å­æœåŠ¡
- [ ] éƒ¨ç½²å…¬ç½‘å¼•å¯¼èŠ‚ç‚¹
- [ ] ä¼˜åŒ–è¿æ¥ç®—æ³•
- [ ] å¢å¼ºç½‘ç»œç›‘æ§

### ä¸­æœŸ (1ä¸ªæœˆ)
- [ ] åœ°ç†ä½ç½®æ„ŸçŸ¥è¿æ¥
- [ ] NATç©¿é€æ”¯æŒ
- [ ] èŠ‚ç‚¹ä¿¡èª‰ç³»ç»Ÿ
- [ ] é«˜çº§ç½‘ç»œæ‹“æ‰‘

### é•¿æœŸ (3ä¸ªæœˆ)
- [ ] å…¨çƒèŠ‚ç‚¹ç½‘ç»œ
- [ ] æ™ºèƒ½è·¯ç”±ä¼˜åŒ–
- [ ] ç½‘ç»œåˆ†æå·¥å…·
- [ ] ä¼ä¸šçº§éƒ¨ç½²

## ğŸ‰ æ€»ç»“

**Agent Chain P2Pè‡ªåŠ¨å‘ç°æœºåˆ¶å·²å®Œå…¨å®ç°ï¼**

âœ… **æŠ€æœ¯æˆå°±**:
- å®ç°äº†å®Œæ•´çš„æ¯”ç‰¹å¸å¼P2På‘ç°æœºåˆ¶
- æ”¯æŒDNSç§å­ã€ç¡¬ç¼–ç ç§å­ã€åœ°å€äº¤æ¢
- è‡ªåŠ¨è¿æ¥ç®¡ç†å’Œç½‘ç»œå¥åº·ç›‘æ§
- å®Œæ•´çš„å‘½ä»¤è¡Œå·¥å…·å’Œç®¡ç†è„šæœ¬

âœ… **ç½‘ç»œèƒ½åŠ›**:
- èŠ‚ç‚¹è‡ªåŠ¨å‘ç°å’Œè¿æ¥
- åŠ¨æ€ç½‘ç»œæ‹“æ‰‘è°ƒæ•´
- æ•…éšœè‡ªåŠ¨æ¢å¤
- æ— ä¸­å¿ƒåŒ–ä¾èµ–

âœ… **æ‰©å±•å°±ç»ª**:
- å¯ä»¥è½»æ¾æ‰©å±•åˆ°å…¨çƒç½‘ç»œ
- æ”¯æŒæ— é™æ•°é‡çš„èŠ‚ç‚¹åŠ å…¥
- å®Œå…¨å»ä¸­å¿ƒåŒ–çš„æ¶æ„

Agent Chainç°åœ¨å…·å¤‡äº†ä¸æ¯”ç‰¹å¸ç›¸åŒçš„P2Pç½‘ç»œå‘ç°èƒ½åŠ›ï¼Œå¯ä»¥å½¢æˆçœŸæ­£çš„å»ä¸­å¿ƒåŒ–å…¨çƒç½‘ç»œï¼

---

**å®ç°çŠ¶æ€**: âœ… å®Œå…¨æˆåŠŸ  
**ç½‘ç»œç±»å‹**: æ¯”ç‰¹å¸å¼å»ä¸­å¿ƒåŒ–P2P  
**ä¸‹ä¸€æ­¥**: éƒ¨ç½²åˆ°å…¬ç½‘å½¢æˆå…¨çƒç½‘ç»œ
